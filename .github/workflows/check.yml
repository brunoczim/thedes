name: Thedes CI - Check
on: [pull_request]

env:
  WASM_BIDGEN_CLI_V: 0.2.100

jobs:
  check-native:
    name: Check Native
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Update rustup
        run: rustup update stable && rustup default stable

      - name: Check
        run: cargo check --workspace --all-targets --all-features

  check-wasm:
    name: Check WASM
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Update rustup
        run: rustup update stable && rustup default stable

      - name: Add WASM target
        run: rustup target add wasm32-unknown-unknown

      - name: Check
        run: |
          cargo check --workspace --all-targets --all-features \
            --target wasm32-unknown-unknown

  test-native:
    name: Test Native
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Update rustup
        run: rustup update stable && rustup default stable

      - name: Test
        run: cargo test --workspace --all-targets --all-features

  test-wasm:
    name: Test WASM
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Update rustup
        run: rustup update stable && rustup default stable

      - name: Add WASM target
        run: rustup target add wasm32-unknown-unknown

      - name: Restore cargo bin cache
        id: restore-cargo-bin
        uses: actions/cache/restore@v4
        with:
          path: ~/.cargo/bin/
          key: ${{ runner.os }}-wasm-bindgen-cli-v${{ env.WASM_BIDGEN_CLI_V }}

      - name: Install WASM bindgen CLI
        if: steps.restore-cargo-bin.outputs.cache-hit != 'true'
        run: |
          cargo install wasm-bindgen-cli --version ${{ env.WASM_BIDGEN_CLI_V }}

      - name: Save cargo bin cache
        id: save-cargo-bin
        uses: actions/cache/save@v4
        with:
          path: ~/.cargo/bin/
          key: ${{ steps.restore-cargo-bin.outputs.cache-primary-key }}

      - name: Test
        run: |
          cargo test --workspace --all-targets --all-features \
            --target wasm32-unknown-unknown

  lints:
    name: Lints
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Update rustup
        run: rustup update nightly && rustup default nightly

      - name: Install rustfmt
        run: rustup component add rustfmt

      - name: Check formatting
        run: cargo fmt --check
